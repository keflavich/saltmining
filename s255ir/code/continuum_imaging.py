import os, glob, re

print("Running continuum imaging")

finalvis = "calibrated_final.ms"

print("Doing continuum")

# Set spws to be used to form continuum
contspws = "25,27,29,31"

contvis = "calibrated_final_cont.ms"

if not os.path.exists(contvis):
    print("Starting continuum split")
    # If you have complex line emission and no dedicated continuum
    # windows, you will need to flag the line channels prior to averaging.
    flagmanager(vis=finalvis, mode="save", versionname="before_cont_flags")

    initweights(vis=finalvis, wtmode="weight", dowtsp=True)

    # Flag the "line channels"
    flagchannels = (
        "25:2~5;25~36;61~62;66~67;84~85;88~88;90~92;94~95;98~101;106~106;136~140;142~143;150~154;160~160;164~164;169~174;180~185;189~194;213~217;231~238;283~286;292~295;306~308;311~311;334~340;380~380;391~395;452~460;493~497;535~537;556~559;569~572;580~582;590~592;630~639;702~706;713~716;763~769;779~781;834~834;838~839;848~850;858~861;872~878;891~891;915~915;919~922;934~934;939~948;955~959;962~967;978~981;986~989;1016~1018;1123~1127;1139~1147;1155~1165;1173~1180;1185~1187;1197~1198;1218~1222;1227~1229;1240~1247;1254~1260;1285~1291;1307~1307;1313~1318;1336~1340;1346~1347;1363~1363;1368~1370;1380~1380;1449~1454;1457~1461;1496~1499;1504~1504;1513~1522;1539~1546;1553~1555;1562~1562;1573~1576;1600~1606;1619~1631;1636~1644;1662~1662;1666~1666;1672~1672;1683~1683;1689~1692;1702~1703;1706~1706;1735~1737;1746~1747;1776~1781;1795~1798;1802~1804;1839~1839;1849~1855;1863~1863;1919~1919,"
        "27:26~31;92~92;102~105;152~154;158~162;172~176;183~188;194~195;199~200;206~206;226~229;234~234;240~240;257~257;279~280;284~289;294~295;312~315;328~328;334~337;369~371;395~395;408~413;416~416;424~424;428~434;445~446;469~472;477~480;487~490;509~511;519~522;540~542;555~561;611~614;626~629;639~643;711~713;721~726;735~739;742~744;754~758;768~770;786~788;800~804;856~859;868~878;912~914;945~948;1032~1035;1052~1057;1151~1151;1167~1168;1194~1199;1217~1217;1243~1250;1266~1273;1345~1348;1392~1396;1408~1416;1446~1450;1453~1456;1466~1467;1504~1508;1516~1518;1538~1539;1593~1596;1667~1689;1697~1701;1783~1788;1813~1817;1870~1874;1880~1883;1919~1919,"
        "29:34~38;52~52;60~61;68~69;84~94;131~134;152~152;158~160;167~172;189~192;205~205;243~249;256~256;268~299;304~312;343~348;352~361;368~370;376~382;392~392;406~406;416~416;423~431;434~434;445~447;452~456;468~474;477~477;491~492;512~514;519~519;525~537;547~547;561~561;565~565;570~574;591~594;598~602;607~607;610~613;625~631;633~633;647~649;652~653;664~666;678~678;703~703;709~709;712~714;727~729;735~735;743~743;747~750;811~811;860~862;871~878;885~885;892~892;899~899;917~918;930~933;935~935;959~961;1019~1019;1057~1057;1070~1073;1105~1105;1121~1127;1141~1142;1158~1158;1172~1173;1179~1182;1185~1185;1211~1211;1220~1224;1229~1230;1247~1247;1249~1250;1259~1259;1273~1276;1301~1306;1319~1324;1336~1345;1372~1375;1416~1416;1442~1443;1461~1464;1471~1479;1503~1503;1513~1516;1537~1541;1582~1589;1606~1607;1624~1624;1628~1628;1637~1642;1669~1689;1709~1712;1721~1722;1727~1727;1736~1738;1758~1761;1777~1777;1783~1783;1809~1809;1814~1823;1825~1826;1831~1832;1834~1842;1844~1846;1849~1849;1858~1858;1861~1861;1888~1888;1905~1905;1913~1913;1916~1916,"
        "31:7~10;16~20;35~35;38~38;44~44;46~47;49~49;53~55;60~62;73~77;80~84;102~106;130~132;148~148;150~150;158~165;172~172;178~181;184~186;191~193;228~228;245~248;253~253;290~290;306~310;347~350;401~403;410~413;440~445;452~454;467~467;471~471;473~473;508~508;524~524;540~542;551~551;561~562;565~569;628~629;661~661;664~664;682~682;693~694;707~719;724~731;745~753;760~761;766~766;775~783;794~795;798~799;816~823;827~828;840~840;857~870;872~881;888~888;922~925;927~927;966~968;986~989;999~1001;1019~1019;1054~1082;1097~1106;1112~1113;1121~1123;1175~1177;1211~1213;1218~1221;1255~1255;1265~1268;1272~1283;1291~1297;1303~1308;1316~1319;1343~1348;1392~1399;1405~1406;1433~1440;1444~1446;1479~1482;1491~1493;1518~1538;1567~1572;1583~1585;1662~1662;1669~1671;1674~1686;1715~1718;1741~1751;1761~1763;1775~1775;1777~1778;1808~1808;1825~1828;1879~1884;1903~1906"
    )

    flagdata(vis=finalvis, mode="manual", spw=flagchannels, flagbackup=False)

    # Average the channels within spws
    contvis = "calibrated_final_cont.ms"
    rmtables(contvis)
    os.system("rm -rf " + contvis + ".flagversions")

    print("Splitting")
    split(
        vis=finalvis,
        spw=contspws,
        outputvis=contvis,
        width=[
            128,
            128,
            128,
            128,
        ],  # number of channels to average together. The final channel width should be less than 125MHz in Bands 3, 4, and 6 and 250MHz in Band 7.
        datacolumn="data",
    )

    # If you flagged any line channels, restore the previous flags
    flagmanager(vis=finalvis, mode="restore", versionname="before_cont_flags")

contimagename = "S255IR-SMA1_sci.spw25_27_29_31.mfs.I.manual"

for ext in [".image", ".mask", ".model", ".image.pbcor", ".psf", ".residual", ".pb", ".sumwt"]:
    rmtables(contimagename + ext)

print("Continuum cleaning")
tclean(
    vis=contvis,
    imagename=contimagename,
    specmode="mfs",
    deconvolver="mtmfs",
    nterms=2,
    field="S255IR-SMA1",
    gridder="standard",
    cell="0.0042arcsec",
    # imsize = [2000,2000], # size of image in pixels.
    imsize=[9600, 9600],
    outframe="lsrk",  # velocity reference frame.
    veltype="radio",  # velocity type.
    weighting="briggs",
    robust=0.0,
    niter=100000,
    threshold="0.1mJy",
    interactive=False,
    pbcor=True,
)

# >>> Note RMS.
# ~2400 iterations
# RMS ~ 34 uJy
# Beam = 0.025 x 0.019 arcsec
