import os, glob, re
finalvis = "calibrated_final.ms"

# *line-free* channels for fitting continuum
fitspw = (
    "25:0~1;6~24;37~60;63~65;68~83;86~87;89~89;93~93;96~97;102~105;107~135;141~141;144~149;155~159;161~163;165~168;175~179;186~188;195~212;218~230;239~282;287~291;296~305;309~310;312~333;341~379;381~390;396~451;461~492;498~534;538~555;560~568;573~579;583~589;593~629;640~701;707~712;717~762;770~778;782~833;835~837;840~847;851~857;862~871;879~890;892~914;916~918;923~933;935~938;949~954;960~961;968~977;982~985;990~1015;1019~1122;1128~1138;1148~1154;1166~1172;1181~1184;1188~1196;1199~1217;1223~1226;1230~1239;1248~1253;1261~1284;1292~1306;1308~1312;1319~1335;1341~1345;1348~1362;1364~1367;1371~1379;1381~1448;1455~1456;1462~1495;1500~1503;1505~1512;1523~1538;1547~1552;1556~1561;1563~1572;1577~1599;1607~1618;1632~1635;1645~1661;1663~1665;1667~1671;1673~1682;1684~1688;1693~1701;1704~1705;1707~1734;1738~1745;1748~1775;1782~1794;1799~1801;1805~1838;1840~1848;1856~1862;1864~1918,"
    "27:0~25;32~91;93~101;106~151;155~157;163~171;177~182;189~193;196~198;201~205;207~225;230~233;235~239;241~256;258~278;281~283;290~293;296~311;316~327;329~333;338~368;372~394;396~407;414~415;417~423;425~427;435~444;447~468;473~476;481~486;491~508;512~518;523~539;543~554;562~610;615~625;630~638;644~710;714~720;727~734;740~741;745~753;759~767;771~785;789~799;805~855;860~867;879~911;915~944;949~1031;1036~1051;1058~1150;1152~1166;1169~1193;1200~1216;1218~1242;1251~1265;1274~1344;1349~1391;1397~1407;1417~1445;1451~1452;1457~1465;1468~1503;1509~1515;1519~1537;1540~1592;1597~1666;1690~1696;1702~1782;1789~1812;1818~1869;1875~1879;1884~1918,"
    "29:0~33;39~51;53~59;62~67;70~83;95~130;135~151;153~157;161~166;173~188;193~204;206~242;250~255;257~267;300~303;313~342;349~351;362~367;371~375;383~391;393~405;407~415;417~422;432~433;435~444;448~451;457~467;475~476;478~490;493~511;515~518;520~524;538~546;548~560;562~564;566~569;575~590;595~597;603~606;608~609;614~624;632~632;634~646;650~651;654~663;667~677;679~702;704~708;710~711;715~726;730~734;736~742;744~746;751~810;812~859;863~870;879~884;886~891;893~898;900~916;919~929;934~934;936~958;962~1018;1020~1056;1058~1069;1074~1104;1106~1120;1128~1140;1143~1157;1159~1171;1174~1178;1183~1184;1186~1210;1212~1219;1225~1228;1231~1246;1248~1248;1251~1258;1260~1272;1277~1300;1307~1318;1325~1335;1346~1371;1376~1415;1417~1441;1444~1460;1465~1470;1480~1502;1504~1512;1517~1536;1542~1581;1590~1605;1608~1623;1625~1627;1629~1636;1643~1668;1690~1708;1713~1720;1723~1726;1728~1735;1739~1757;1762~1776;1778~1782;1784~1808;1810~1813;1824~1824;1827~1830;1833~1833;1843~1843;1847~1848;1850~1857;1859~1860;1862~1887;1889~1904;1906~1912;1914~1915;1917~1919,"
    "31:0~6;11~15;21~34;36~37;39~43;45~45;48~48;50~52;56~59;63~72;78~79;85~101;107~129;133~147;149~149;151~157;166~171;173~177;182~183;187~190;194~227;229~244;249~252;254~289;291~305;311~346;351~400;404~409;414~439;446~451;455~466;468~470;472~472;474~507;509~523;525~539;543~550;552~560;563~564;570~627;630~660;662~663;665~681;683~692;695~706;720~723;732~744;754~759;762~765;767~774;784~793;796~797;800~815;824~826;829~839;841~856;871~871;882~887;889~921;926~926;928~965;969~985;990~998;1002~1018;1020~1053;1083~1096;1107~1111;1114~1120;1124~1174;1178~1210;1214~1217;1222~1254;1256~1264;1269~1271;1284~1290;1298~1302;1309~1315;1320~1342;1349~1391;1400~1404;1407~1432;1441~1443;1447~1478;1483~1490;1494~1517;1539~1566;1573~1582;1586~1661;1663~1668;1672~1673;1687~1714;1719~1740;1752~1760;1764~1774;1776~1776;1779~1807;1809~1824;1829~1878;1885~1902;1907~1919"
)

# something in this process corrupted the underlying MS several times
# the line channels all imaged 100% flagged out
# so I think I'll skip uvcontsub?
finalvis = "calibrated_final.ms"
linevis = finalvis + ".contsub"  # uncomment if continuum subtracted
linevis = finalvis # don't contsub because contsub breaks the data (and who cares anyway?)

linespw = "25,27,29,31"

# if False and not os.path.exists(linevis):
#     uvcontsub(
#         vis=finalvis,
#         spw=linespw,  # spw to do continuum subtraction on
#         fitspw=fitspw,  # regions without lines.
#         excludechans=False,  # fit the regions in fitspw
#         # combine='spw', #uncomment if there are no line-free channels in the line spectral window.
#         solint="int",
#         fitorder=1,
#         want_cont=False,
#     )  # This value should not be changed.

for spw in "0123":
    orig_spw = 25 + int(spw) * 2

    print(f"Imaging SPW={spw} (originally {orig_spw})")
    lineimagename = f"S255IR-SMA1_sci.spw{spw}.cube.I.zoom.manual"


    if not os.path.exists(lineimagename + ".image") and not os.path.exists(lineimagename + ".psf") and not os.path.exists(lineimagename + ".pb"):
        # FORCE unflag the data. 
        flagdata(linevis, spw=str(orig_spw), antenna='*&*', mode='unflag')

        tclean(
            vis=linevis,
            imagename=lineimagename,
            field="S255IR-SMA1",
            spw=str(orig_spw),
            specmode="cube",
            perchanweightdensity=True,
            outframe="lsrk",
            veltype="radio",
            interactive=False,
            cell="0.0042arcsec",
            niter=10000,
            threshold="10mJy",
            imsize=[500, 500],
            weighting="briggs",
            robust=0.0,
            gridder="standard",
            pbcor=True,
            # restoringbeam='common',
            parallel=False,
            usepointing=False,
        )
